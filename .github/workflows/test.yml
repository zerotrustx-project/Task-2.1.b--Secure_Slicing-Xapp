name: Testing Secure Slicing xApp
on:
  push:
    branches:
    - testing
  pull_request:
    branches:
    - master

jobs:
  build:
    runs-on: Ubuntu-20.04
    timeout-minutes: 90  
    steps:
    - name: Checkout
      uses: actions/checkout@master
      with:
        fetch-depth: 0 # otherwise will fail to push refs to dest repo

    - name: Install OAIC directory
      run: |
          cd ~/
          git clone https://github.com/openaicellular/oaic.git
          cd ~/oaic 
          sudo apt-get update
          pip3 install docutils
          git submodule update --init --recursive --remote 
          python3 generate_installation_script.py
          sudo swapoff -a
          
    - name: Install Dependencies
      run: |
          sudo apt install nfs-common
          sudo apt-get install build-essential cmake libfftw3-dev libmbedtls-dev libboost-program-options-dev libconfig++-dev libsctp-dev libtool autoconf
          sudo apt-get install libzmq3-dev
          sudo apt install libtool autoconf
          sudo apt-get install install gnuradio
          
    - name: Install asn1c Compiler
      run: |
          cd ~/oaic/asn1c
          autoreconf -iv
          ./configure
          make -j4
          sudo make install
          sudo ldconfig

    - name: Install O-RAN Near Real-Time RIC
      run: |
          # Step 2: Install Kubernetes, Docker, and Helm (4 minutes)
          sudo apt remove containernetworking-plugins
          cd ~/oaic/RIC-Deployment/tools/k8s/bin
          ./gen-cloud-init.sh
          sudo ./k8s-1node-cloud-init-k_1_16-h_2_17-d_cur.sh
          sudo kubectl get pods -A
          sudo kubectl create ns ricinfra
          sudo helm install stable/nfs-server-provisioner --namespace ricinfra --name nfs-release-1
          sudo kubectl patch storageclass nfs -p '{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'
          # Step 3: Build Modified E2 docker Image (7 minutes)
          sudo docker run -d -p 5001:5000 --restart=always --name ric registry:2
          cd ../../../..
          cd ric-plt-e2
          cd RIC-E2-TERMINATION
          sudo docker build -f Dockerfile -t localhost:5001/ric-plt-e2:5.5.0 .
          sudo docker push localhost:5001/ric-plt-e2:5.5.0
          cd ../../
          # Step 4: Deploy the near-Real Time RIC (3 minutes)
          cd RIC-Deployment/bin
          sudo ./deploy-ric-platform -f ../RECIPE_EXAMPLE/PLATFORM/example_recipe_oran_e_release_modified_e2.yaml
          sudo kubectl get pods -A
          
    - name: Install srslte with E2 Agent
      run: |
          # compile srslte-e2 (19 minutes without running tests)
          cd ~/oaic
          git clone https://github.com/openaicellular/srslte-e2
          cd srslte-e2
          rm -rf build
          mkdir build
          export SRS=`realpath .`
          cd build
          cmake ../ -DCMAKE_BUILD_TYPE=RelWithDebInfo \
                -DRIC_GENERATED_E2AP_BINDING_DIR=${SRS}/e2_bindings/E2AP-v01.01 \
                -DRIC_GENERATED_E2SM_KPM_BINDING_DIR=${SRS}/e2_bindings/E2SM-KPM \
                -DRIC_GENERATED_E2SM_GNB_NRT_BINDING_DIR=${SRS}/e2_bindings/E2SM-GNB-NRT
          make -j`nproc`
          sudo make install
          sudo ldconfig
          sudo srslte_install_configs.sh service

    - name: Setup Nginx Web Server
      run: |
          sudo apt-get install nginx
          sudo systemctl start nginx.service

          sudo chmod -R 777 /etc/nginx
          cd /etc/nginx/sites-enabled
          sudo unlink default
          cd ../../../var/www
          sudo mkdir xApp_config.local
          cd xApp_config.local/
          sudo mkdir config_files

          cd ../../../etc/nginx/conf.d
          
          sudo echo -e " \
          server { \n \
          listen 5010 default_server; \n \
          server_name xApp_config.local; \n \
          location /config_files/ { \n \
          \n \
          root /var/www/xApp_config.local/; \n \
          } \n \
          \n \
          }" >> xApp_config.local.conf

          echo ">>> reloading nginx..."
          sudo nginx -t

    - name: Deploying the Secure Slicing xApp
      run: |
          sudo cp config-file.json /var/www/xApp_config.local/config_files/
          sudo systemctl reload nginx
          sudo chmod +x ./cmake/tools/make_asn1c_includes.sh
          sudo docker build . -t xApp-registry.local:5008/ss:0.1.0
          IP=`hostname  -I | cut -f1 -d' '`

          sudo echo " \
          {"config-file.json_url":"http://${IP}:5010/config_files/config-file.json"} \
          " >> ss-xapp-onboard.url

          sudo kubectl get pods -A

          export KONG_PROXY=`sudo kubectl get svc -n ricplt -l app.kubernetes.io/name=kong -o jsonpath='{.items[0].spec.clusterIP}'`
          export E2MGR_HTTP=`sudo kubectl get svc -n ricplt --field-selector metadata.name=service-ricplt-e2mgr-http -o jsonpath='{.items[0].spec.clusterIP}'`
          export APPMGR_HTTP=`sudo kubectl get svc -n ricplt --field-selector metadata.name=service-ricplt-appmgr-http -o jsonpath='{.items[0].spec.clusterIP}'`
          export E2TERM_SCTP=`sudo kubectl get svc -n ricplt --field-selector metadata.name=service-ricplt-e2term-sctp-alpha -o jsonpath='{.items[0].spec.clusterIP}'`
          export ONBOARDER_HTTP=`sudo kubectl get svc -n ricplt --field-selector metadata.name=service-ricplt-xapp-onboarder-http -o jsonpath='{.items[0].spec.clusterIP}'`
          export RTMGR_HTTP=`sudo kubectl get svc -n ricplt --field-selector metadata.name=service-ricplt-rtmgr-http -o jsonpath='{.items[0].spec.clusterIP}'`

          curl -L -X POST "http://$KONG_PROXY:32080/onboard/api/v1/onboard/download" --header 'Content-Type: application/json' --data-binary "@ss-xapp-onboard.url"
          curl -L -X GET "http://$KONG_PROXY:32080/onboard/api/v1/charts"
          curl -L -X POST "http://$KONG_PROXY:32080/appmgr/ric/v1/xapps" --header 'Content-Type: application/json' --data-raw '{"xappName": "ss"}'
          sudo kubectl get pods -A
          
    - name: Set up 5G Network
      run: |
          echo ">>> Adding UE1..."
          sudo ip netns add ue1
          echo ">>> Adding UE2..."
          sudo ip netns add ue2
          echo ">>> Adding UE3..."
          sudo ip netns add ue3
          echo ">>> Starting EPC..."
          sudo srsepc & pid_epc=$!
          echo ">>> Getting E2NODE IP..."
          export E2NODE_IP=`hostname  -I | cut -f1 -d' '`
          echo ">>> E2NODE IP is ${E2NODE_IP}"
          export E2NODE_PORT=5006
          echo ">>> Getting E2TERM IP..."
          export E2TERM_IP=`sudo kubectl get svc -n ricplt --field-selector metadata.name=service-ricplt-e2term-sctp-alpha -o jsonpath='{.items[0].spec.clusterIP}'`
           echo ">>> Starting eNB..."
          sudo srsenb --enb.n_prb=100 --enb.name=enb1 --enb.enb_id=0x19B \
          --rf.device_name=zmq --rf.device_args="fail_on_disconnect=true,tx_port=tcp://*:2000,rx_port=tcp://localhost:2009,id=enb,base_srate=23.04e6" --ric.agent.remote_ipv4_addr=${E2TERM_IP} --log.all_level=warn --ric.agent.log_level=debug --log.filename=stdout --ric.agent.local_ipv4_addr=${E2NODE_IP} --ric.agent.local_port=${E2NODE_PORT} --slicer.enable=1 --slicer.workshare=0 & pid_enb=$!
          echo ">>> eNB started with pid ${pid_enb}"
          echo ">>> Waiting for RIC state to establish"
          sleep 120
          echo ">>> Starting UE1..."
          sudo srsue \
          --rf.device_name=zmq --rf.device_args="tx_port=tcp://*:2010,rx_port=tcp://localhost:2300,id=ue,base_srate=23.04e6" --usim.algo=xor --usim.imsi=001010123456789 --usim.k=00112233445566778899aabbccddeeff --usim.imei=353490069873310 --log.all_level=warn --log.filename=stdout --gw.netns=ue1 & pid_ue1=$!
          echo ">>> Starting UE2..."
          sudo srsue \
          --rf.device_name=zmq --rf.device_args="tx_port=tcp://*:2007,rx_port=tcp://localhost:2400,id=ue,base_srate=23.04e6" --usim.algo=xor --usim.imsi=001010123456780 --usim.k=00112233445566778899aabbccddeeff --usim.imei=353490069873310 --log.all_level=warn --log.filename=stdout --gw.netns=ue2 & pid_ue2=$!
          echo ">>> Starting UE3..."
          sudo srsue \
          --rf.device_name=zmq --rf.device_args="tx_port=tcp://*:2008,rx_port=tcp://localhost:2500,id=ue,base_srate=23.04e6" --usim.algo=xor --usim.imsi=001010123456781 --usim.k=00112233445566778899aabbccddeeff --usim.imei=353490069873310 --log.all_level=warn --log.filename=stdout --gw.netns=ue3 & pid_ue3=$!
          sleep 120
          
          python3 multi_ue.py

          echo ">>> Pinging IP address..."

          while ! sudo ip netns exec ue1 ping 172.16.0.1 -c3; do echo "UE1 Ping Fail"; done ; echo "UE1 setup completed" ;
          while ! sudo ip netns exec ue1 ping 172.16.0.1 -c3; do echo "UE2 Ping Fail"; done ; echo "UE2 setup completed" ;
          while ! sudo ip netns exec ue1 ping 172.16.0.1 -c3; do echo "UE3 Ping Fail"; done ; echo "UE3 setup completed" ;

          echo ">>> 5G Network setup completed"

    - name: Testing Secure Slicing xApp
      run: |
          sudo chmod +x zmqthreeue.sh
          sudo ./zmqthreeue.sh
